let sentenceCategories = window.sentenceCategories || {
    middleRow: {
        name: "ì¤‘ê°„ í–‰ í‚¤ë³´ë“œ ì—°ìŠµ",
        description: "ì¤‘ê°„ í–‰ í‚¤ë³´ë“œ ìíŒ ì—°ìŠµì„ ìœ„í•œ ë¬¸ì¥ë“¤",
        sentences: [
            //middle row keyboard
            "Dad had a gala in a hall.",
            "Sally adds salad for a lad.",
            "Hal has a flask for gala.",
            "A lad shall dash to a hall.",
            "Dad asks Sally for salad.",
            "Gala had a salad for all.",
            "Sally had half a flask.",
            "A lad had salad at gala.",
            "Hal had a hall all day.",
            "Dad shall add salad now.",
            "Sally has a gala in May.",
            "A lad had a gala at hall.",
            "Dad asks Hal for a gala.",
            "All salad had half salt.",
            "Sally had a half flask.",
            "Gala had salad for Dad.",
            "A lad shall add half salt.",
            "Sally had gala all day.",
            "Dad had a salad at gala.",
            "Hal had gala salad too.",
            "All lads had salad at gala.",
            "Sally had a hall for gala.",
            "Gala had half a salad.",
            "Dad adds salt for salad.",
            "A lad shall add salad.",
            "Hal had salad at gala.",
            "All gala had half salad.",
            "Sally shall dash to gala.",
            "Dad had salad for Sally.",
            "Hal had gala for a lad.",
            "Sally adds half salt fast.",
            "Gala has salad for all.",
            "Dad shall add a salad.",
            "All lads had gala food.",
            "Sally had gala at dawn.",
            "Gala had salad in hall.",
            "Dad had gala with Sally.",
            "A lad had gala in hall.",
            "Sally had half salad.",
            "Gala had all salad.",
            "Dad asks for gala salad.",
            "Sally adds gala to list.",
            "Hal had salad with Dad.",
            "All gala had lads dash.",
            "Sally shall dash for gala.",
            "Dad adds half salad.",
            "Gala had salad at dawn.",
            "Hal adds salt to salad.",
            "Sally had gala for Dad.",
            "Dad had gala with lads."
        ]
    },
    middleRowLetters: {
        name: "ì¤‘ê°„ í–‰ ì•ŒíŒŒë²³ ì—°ìŠµ",
        description: "ì¤‘ê°„ í–‰ì˜ ê° ì•ŒíŒŒë²³ì„ í•˜ë‚˜ì”© íƒ€ì´í•‘í•©ë‹ˆë‹¤",
        sentences: [
            "a", "s", "d", "f", "g", "h", "j", "k", "l",
            "l", "k", "j", "h", "g", "f", "d", "s", "a",
            "a", "s", "d", "f", "j", "k", "l", "h", "g",
            "g", "h", "j", "k", "l", "k", "j", "h", "g",
            "a", "d", "f", "s", "j", "k", "l", "a", "s", "d", "f", "j", "k", "l"
        ]
    },
    topRow: {
        name: "ìƒë‹¨ í–‰ í‚¤ë³´ë“œ ì—°ìŠµ",
        description: "ìƒë‹¨ í–‰ í‚¤ë³´ë“œ ìíŒ ì—°ìŠµì„ ìœ„í•œ ë¬¸ì¥ë“¤",
        sentences: [
            "Peter had a salad for lunch.",
            "Julia will type fast for class.",
            "Fred kept all quiet in hall.",
            "Kate read the gala list aloud.",
            "Paul asked Sally for help.",
            "Ruth had salad with Paul.",
            "Jerry will read fast at gala.",
            "Tim kept all quiet in hall.",
            "Julie had tea at a gala.",
            "Paul read that Sally sang.",
            "Peter will read all the maps.",
            "Fred had soup and salad.",
            "Kate will type fast and well.",
            "Jerry asked Ruth for tea.",
            "Paul kept that list in hall.",
            "Ruth will read gala news.",
            "Julie had quick tea break.",
            "Fred read tall tales aloud.",
            "Peter kept Sallyâ€™s tea hot.",
            "Kate asked Paul for help.",
            "Tim read all about the play.",
            "Julie will type fast for work.",
            "Paul kept Ruthâ€™s seat safe.",
            "Ruth had tea and salad.",
            "Jerry read all the gala notes.",
            "Peter will ask for quick help.",
            "Fred read maps in the hall.",
            "Kate kept a gala list neat.",
            "Julie will read the news.",
            "Paul had tea with Kate.",
            "Jerry typed all the notes fast.",
            "Fred kept all data safe.",
            "Peter read the gala news.",
            "Kate had soup and salad.",
            "Tim asked Julie for help.",
            "Paul kept all quiet in hall.",
            "Julie typed the gala menu.",
            "Ruth read tales aloud today.",
            "Fred kept a map for Peter.",
            "Jerry will read at the gala.",
            "Kate read all the plays aloud.",
            "Peter kept all lists safe.",
            "Fred typed a gala report.",
            "Julie read the tea menu.",
            "Paul kept Ruthâ€™s seat safe.",
            "Jerry had soup and salad.",
            "Tim read the gala notes.",
            "Kate kept all the maps safe.",
            "Fred read the gala speech.",
            "Julie typed all the data."
        ]
    },
    bottomRow: {
        name: "í•˜ë‹¨ í–‰ í‚¤ë³´ë“œ ì—°ìŠµ",
        description: "í•˜ë‹¨ í–‰ í‚¤ë³´ë“œ ìíŒ ì—°ìŠµì„ ìœ„í•œ ë¬¸ì¥ë“¤",
        sentences: [
            "Max had a salad at noon.",
            "Sam will bake muffins today.",
            "Ben fixed a small lamp.",
            "Dan made a calm plan.",
            "Val had jam and milk.",
            "Zack was calm and kind.",
            "Mom baked muffins fast.",
            "Nina made a small map.",
            "Sam had jam with bread.",
            "Ben was calm all day.",
            "Val made a milk shake.",
            "Dan baked a small cake.",
            "Mom fixed the lamp base.",
            "Nina had jam for lunch.",
            "Zack made a calm plan.",
            "Ben had a muffin snack.",
            "Max baked a small loaf.",
            "Sam was calm and happy.",
            "Val made jam at home.",
            "Dan had milk with cake.",
            "Mom baked a calm loaf.",
            "Nina made a lamp stand.",
            "Zack was kind and calm.",
            "Max fixed the lamp base.",
            "Sam made jam with milk.",
            "Ben baked a small bun.",
            "Val had a calm smile.",
            "Dan was kind all day.",
            "Mom made muffins fast.",
            "Zack baked jam rolls.",
            "Nina had milk and jam.",
            "Max made a calm plan.",
            "Sam baked a small loaf.",
            "Ben had jam with milk.",
            "Val was calm and kind.",
            "Dan made jam rolls.",
            "Mom baked a muffin tray.",
            "Nina was kind to Sam.",
            "Zack had milk and cake.",
            "Max baked a calm cake.",
            "Sam made a lamp base.",
            "Ben was calm at home.",
            "Val baked muffins today.",
            "Dan had a calm plan.",
            "Mom fixed the small lamp.",
            "Nina baked a milk loaf.",
            "Zack made a muffin tray.",
            "Max was calm with Sam.",
            "Sam baked jam muffins.",
            "Ben had milk with cake."
        ]
    },
    realEnglish: {
        name: "ì‹¤ì œ ì˜ì–´ ë¬¸ì¥ ì—°ìŠµ",
        description: "ì‹¤ì œ ìƒí™©ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì˜ì–´ ë¬¸ì¥ë“¤",
        sentences: [
            "Camels use the fat for energy.",
            "One day, they jump out from mom's pouch.",
            "The chameleon goes quickly to the green glass and turns green.",
            "They sing to attract females.",
            "Nobody knows for sure why they died out.",
            "I look like a tiger.",
            "I use my forked tongue to smell.",
            "Even when we are sleeping, we are hanging upside down.",
            "Whale can't breathe through the water.",
            "They fly in a V-shape.",
            "Your legs are covered with fine hair.",
            "I am making the webs to catch bugs.",
            "I try to reach the leaves at the top of them, so I have a long neck.",
            "The bees started to put honey in their house.",
            "Winter is too cold for bear to catch prey, so they have a long winter sleep.",
            "It changes sunlight into energy.",
            "They store lots of water in their trunks.",
            "Spores are everywhere.",
            "Something scary seems to happen.",
            "It is easy for them to get dirty.",
            "Count the tree rings on the stumps.",
            "Each firefly sends a different signal.",
            "The ink can also make your eyes hurt.",
            "A wet nose helps them smell better.",
            "She was tickling the sole of dad's foot with a brush.",
            "It also protects your ears from loud noises.",
            "Minhee got a tape recorder for her birthday.",
            "Why do I burp when I drink soda?",
            "The air pressure inside and outside your ear is not the same.",
            "The skin (which covers your hands and feet) absorbs water well.",
            "When you see delicious food, your mouth starts to water.",
            "A bump appeared at once. It was very itchy.",
            "The sun can be harmful for your skin.",
            "You can gulp lots of fresh air when you yawn.",
            "If you want to stop hiccuping, try to hold your breath.",
            "Sneezing can remove germs and dust from the nose.",
            "It delivers oxygen and nutrients to our body.",
            "All people have different spots for sweat glands on their fingers.",
            "Our tongue can taste sweet, salty, bitter and sour.",
            "If our body loses its balance, the water in our ears is not calm.",
            "Our brains sort and store information while we're sleeping.",
            "Sometimes the gas goes up and out. It is called a burp.",
            "Goose bumps don't let us lose our body heat.",
            "My little teeth don't fit my mouth and jaw anymore.",
            "What do other people think about cloning?",
            "Your belly button is the spot where the umbilical cord used to be.",
            "If you are color-blind, you might think that green leaves are gray.",
            "Germs like playing in your sweaty shoes.",
            "By the way, why do people think rumbling is a sign of hunger?",
            "Soap bubbles like to stick together.",
            "A kernel of corn has a little bit of water in it.",
            "Salt lowers the freezing point of water.",
            "The heat first divides the proteins.",
            "Density means how close A and B are.",
            "Microwaves go through the bread, and heat only the water in the bread.",
            "Don't open attached files you don't know.",
            "If the temperature gets cooler, the water in the air turns into a liquid.",
            "The pictures pass quickly so they look like they are in motion.",
            "A glow stick is put in a plastic tube, and in a glow stick, two kinds of liquid are in separate areas.",
            "If you touch electrical devices with a wet hand, you may get an electric shock."
        ]
    }
};

// ì¤‘ê°„ í–‰ ì•ŒíŒŒë²³ ì—°ìŠµì— ëœë¤ 30ê°œ ì¶”ê°€
(function () {
    const middleRowKey = 'middleRowLetters';
    const letters = ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'];
    const extraCount = 30;
    if (sentenceCategories[middleRowKey]) {
        for (let i = 0; i < extraCount; i++) {
            const letter = letters[Math.floor(Math.random() * letters.length)];
            sentenceCategories[middleRowKey].sentences.push(letter);
        }
    }
})();

// ê°€ìš´ë°+ìœ—ì¤„, ê°€ìš´ë°+ì•„ë«ì¤„ í•©ì„± ì¹´í…Œê³ ë¦¬ ìƒì„± ë° ì§„í–‰ ìˆœì„œ ì •ì˜
(function () {
    const interleave = (arrA, arrB, limitPerSource) => {
        const takeA = arrA.slice(0, limitPerSource);
        const takeB = arrB.slice(0, limitPerSource);
        const result = [];
        const maxLen = Math.max(takeA.length, takeB.length);
        for (let i = 0; i < maxLen; i++) {
            if (i < takeA.length) result.push(takeA[i]);
            if (i < takeB.length) result.push(takeB[i]);
        }
        return result;
    };
    const cap = 80; // ê° ì†ŒìŠ¤ì—ì„œ ìµœëŒ€ capê°œë§Œ ì‚¬ìš©
    sentenceCategories.middleTopCombo = {
        name: 'ê°€ìš´ë°ì™€ ìœ—ì¤„ ì—°ìŠµ',
        description: 'ê°€ìš´ë° í–‰ê³¼ ìœ—ì¤„ í‚¤ ì¡°í•©ì„ ì—°ìŠµí•©ë‹ˆë‹¤',
        sentences: interleave(
            sentenceCategories.middleRow.sentences,
            sentenceCategories.topRow.sentences,
            cap
        )
    };
    sentenceCategories.middleBottomCombo = {
        name: 'ê°€ìš´ë°ì™€ ì•„ë«ì¤„ ì—°ìŠµ',
        description: 'ê°€ìš´ë° í–‰ê³¼ ì•„ë«ì¤„ í‚¤ ì¡°í•©ì„ ì—°ìŠµí•©ë‹ˆë‹¤',
        sentences: interleave(
            sentenceCategories.middleRow.sentences,
            sentenceCategories.bottomRow.sentences,
            cap
        )
    };
})();

function getSortedKeysByLevel() {
    const entries = Object.entries(sentenceCategories);
    const withLevels = [];
    for (let i = 0; i < entries.length; i++) {
        const [key, category] = entries[i];
        if (typeof category.level === 'number') {
            withLevels.push({ key, level: category.level });
        }
    }
    withLevels.sort((a, b) => a.level - b.level);
    const keys = [];
    for (let i = 0; i < withLevels.length; i++) {
        keys.push(withLevels[i].key);
    }
    return keys;
}

function getNextCategoryKey(currentKey) {
    const orderedKeys = getSortedKeysByLevel();
    const idx = orderedKeys.indexOf(currentKey);
    if (idx >= 0 && idx < orderedKeys.length - 1) return orderedKeys[idx + 1];
    return null;
}

let currentCategory = null;
let currentSentenceIndex = 0;
let startTime = null;
let timer = null;
let isTyping = false;
let totalWords = 0;
let totalTime = 0;
let correctWords = 0;
let errorWords = [];
let sessionErrors = [];

// ê¸°ë³¸ ë°°ê²½ ì €ì¥
let defaultBodyBackground = '';

// í…ŒìŠ¤íŠ¸ ëª¨ë“œ: trueë©´ ê° ë‹¨ê³„ì˜ 10% ì™„ë£Œ ì‹œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
let isTestMode = true; // í•„ìš” ì‹œ URL íŒŒë¼ë¯¸í„°ë‚˜ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë¡œ ì œì–´ ê°€ëŠ¥
const TEST_MODE_THRESHOLD_RATIO = 0.1;

function goToCategory(newKey, keepSession = true) {
    if (!sentenceCategories[newKey]) return;
    currentCategory = newKey;
    currentSentenceIndex = 0;
    if (typeof typingInput !== 'undefined') {
        typingInput.value = '';
        typingInput.className = 'typing-input';
    }
    if (typeof accuracyIndicator !== 'undefined') {
        accuracyIndicator.textContent = '';
    }
    updateDisplay();
    updateLevelBadge();
    applyCategoryTheme();
    // ì…ë ¥ ì¹¸ ì¦‰ì‹œ í¬ì»¤ìŠ¤ (ì§€ì—° ì¬ì‹œë„)
    setTimeout(() => focusTypingInput(), 0);
    if (keepSession && isTyping && !timer) {
        startTimer();
    }
}

// ì¹´í…Œê³ ë¦¬ ë©”ë‰´ ì´ˆê¸°í™”
function initializeCategoryMenu() {
    const categoryMenu = document.getElementById('categoryMenu');
    const typingArea = document.getElementById('typingArea');

    const orderedKeys = getSortedKeysByLevel();

    for (let i = 0; i < orderedKeys.length; i++) {
        const key = orderedKeys[i];
        const category = sentenceCategories[key];
        const card = document.createElement('div');
        card.className = 'category-card';
        const icon = getCategoryIcon(key, category.level);
        const hl = getHighlightForCategory(key);
        const kb = hl === 'none' ? '' : `<div class="keyboard-icon">${getKeyboardSVG(hl)}</div>`;
        card.innerHTML = `
            <h3><span class="category-icon">${icon}</span>${i + 1}. ${category.name}</h3>
            <p>${category.description}</p>
            <div class="category-stats">
                <span>${category.sentences.length} ë¬¸ì¥</span>
                <span>ë ˆë²¨: ${category.level ?? '-'} / ë‚œì´ë„: ${getDifficulty(category.sentences)}</span>
            </div>
            ${kb}
        `;

        card.addEventListener('click', () => {
            currentCategory = key;
            currentSentenceIndex = 0;
            resetTyping();
            categoryMenu.style.display = 'none';
            typingArea.classList.add('active');
            updateDisplay();
            updateLevelBadge();
            // ì…ë ¥ ì¹¸ í¬ì»¤ìŠ¤ ë³´ì¥
            setTimeout(() => focusTypingInput(), 0);
        });

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ì…ë ¥ ì¹¸ì— ì¦‰ì‹œ í¬ì»¤ìŠ¤ (ì§€ì—° ì¬ì‹œë„)
        setTimeout(() => focusTypingInput(), 0);

        categoryMenu.appendChild(card);
    }
}

// ì¹´í…Œê³ ë¦¬ì˜ ë‚œì´ë„ ê³„ì‚°
function getDifficulty(sentences) {
    const avgLength = sentences.reduce((sum, sent) => sum + sent.length, 0) / sentences.length;
    if (avgLength < 30) return 'ì‰¬ì›€';
    if (avgLength < 50) return 'ë³´í†µ';
    return 'ì–´ë ¤ì›€';
}

// íƒ€ì´í•‘ ì˜ì—­ìœ¼ë¡œ ëŒì•„ê°€ê¸°
function backToMenu() {
    const categoryMenu = document.getElementById('categoryMenu');
    const typingArea = document.getElementById('typingArea');

    categoryMenu.style.display = 'grid';
    typingArea.classList.remove('active');
    resetTyping();
    resetDefaultTheme();
    // ì»¨í…Œì´ë„ˆ í­ ì´ˆê¸°í™”
    const container = document.querySelector('.container');
    if (container) container.style.maxWidth = '';
}

function showToast(message, durationMs = 1500) {
    if (!toastEl) return;
    toastEl.textContent = message;
    toastEl.classList.add('show');
    window.clearTimeout(showToast._t);
    showToast._t = window.setTimeout(() => {
        toastEl.classList.remove('show');
    }, durationMs);
}

function updateLevelBadge() {
    if (!levelBadge) return;
    if (!currentCategory) {
        levelBadge.style.display = 'none';
        return;
    }
    const cat = sentenceCategories[currentCategory];
    const levelText = typeof cat.level === 'number' ? `ë ˆë²¨ ${cat.level}` : 'ë ˆë²¨ -';
    levelBadge.textContent = `${levelText} â€¢ ${cat.name}`;
    levelBadge.style.display = 'inline-block';
}

const defaultThemeByLevel = {
    1: { gradient: 'linear-gradient(135deg, #e0f7ff 0%, #b3e5fc 100%)', gradientDark: 'linear-gradient(135deg, #0d47a1 0%, #1565c0 100%)' },
    2: { gradient: 'linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%)', gradientDark: 'linear-gradient(135deg, #4527a0 0%, #5e35b1 100%)' },
    3: { gradient: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)', gradientDark: 'linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%)' },
    4: { gradient: 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)', gradientDark: 'linear-gradient(135deg, #e65100 0%, #ef6c00 100%)' },
    5: { gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', gradientDark: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)' }
};

function applyCategoryTheme() {
    const cat = currentCategory ? sentenceCategories[currentCategory] : null;
    if (!defaultBodyBackground) {
        defaultBodyBackground = document.body.style.background || '';
    }
    // ë¶€ë“œëŸ¬ìš´ ì „í™˜ ì ìš©
    document.body.style.transition = 'background 300ms ease';

    // gradient ìš°ì„ , ì—†ìœ¼ë©´ color
    const gradient = cat && (cat.gradient || (cat.level && defaultThemeByLevel[cat.level]?.gradient));
    const color = cat && cat.color;

    if (gradient) {
        document.body.style.background = gradient;
    } else if (color) {
        document.body.style.background = color;
    } else {
        document.body.style.background = defaultBodyBackground;
    }

    // ë‹¤í¬ ëª¨ë“œ ë³´ì •: ì‹œìŠ¤í…œ ë‹¤í¬ ëª¨ë“œë©´ colorDark/gradientDark ìš°ì„  ì ìš©
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        const gradientDark = cat && (cat.gradientDark || (cat.level && defaultThemeByLevel[cat.level]?.gradientDark));
        const colorDark = cat && cat.colorDark;
        if (gradientDark) {
            document.body.style.background = gradientDark;
        } else if (colorDark) {
            document.body.style.background = colorDark;
        }
    }
}

function resetDefaultTheme() {
    if (defaultBodyBackground) {
        document.body.style.background = defaultBodyBackground;
    } else {
        document.body.style.background = '';
    }
}

const sentenceDisplay = document.getElementById('sentenceDisplay');
const typingInput = document.getElementById('typingInput');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const nextBtn = document.getElementById('nextBtn');
const wpmDisplay = document.getElementById('wpm');
const accuracyDisplay = document.getElementById('accuracy');
const timerDisplay = document.getElementById('timer');
const progressBar = document.getElementById('progress');
const accuracyIndicator = document.getElementById('accuracyIndicator');
const remainingInfo = document.getElementById('remainingInfo');
const levelBadge = document.getElementById('levelBadge');
const toastEl = document.getElementById('toast');
const asciiRunnerEl = document.getElementById('asciiRunner');
let asciiFramesLibrary = {};
let asciiRunnerFrames = [];
let asciiRunnerIndex = 0;
let asciiRunnerFramesOverride = [];
let asciiCurrentAnimal = null;
let asciiLastCorrectCharCount = 0;
let asciiKeyCounter = 0;
let asciiAdvanceEveryN = 1; // í‚¤ ì…ë ¥ níšŒë§ˆë‹¤ 1í”„ë ˆì„ ì „í™˜ (ìš”ì²­ì— ë”°ë¼ ê¸°ë³¸ 1)
let asciiAdvanceOnlyOnCorrect = false; // ìš”ì²­ì— ë”°ë¼ í‚¤ ì…ë ¥ ì‹œ í•­ìƒ ì§„í–‰
let asciiLarge = true; // 2ë°° í¬ê¸°

async function loadAsciiFrames() {
    try {
        const res = await fetch('asciiRunnerFrames.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to load asciiRunnerFrames.json');
        const data = await res.json();
        asciiFramesLibrary = data || {};
        // ê¸°ë³¸ì€ ë§ í”„ë ˆì„
        asciiRunnerFrames = asciiFramesLibrary.horse || [];
        if (!Array.isArray(asciiRunnerFrames)) asciiRunnerFrames = [];
    } catch (err) {
        console.error('[loadAsciiFrames] ', err);
        asciiFramesLibrary = {};
        asciiRunnerFrames = [];
    }
}

function setAsciiScale() {
    if (!asciiRunnerEl) return;
    if (asciiLarge) asciiRunnerEl.classList.add('ascii-large');
    else asciiRunnerEl.classList.remove('ascii-large');
}

function focusTypingInput(retries = 6, delayMs = 80) {
    if (!typingInput) return;
    const tryFocus = () => {
        // ë³´ì´ëŠ” ìƒíƒœì¸ì§€ í™•ì¸
        const isHidden = typingInput.offsetParent === null;
        if (!isHidden) {
            typingInput.focus({ preventScroll: false });
            try {
                // ì»¤ì„œë¥¼ í•­ìƒ ëìœ¼ë¡œ ì´ë™
                const len = typingInput.value.length;
                typingInput.setSelectionRange(len, len);
            } catch (_) {}
            return true;
        }
        return false;
    };
    if (tryFocus()) return;
    if (retries > 0) setTimeout(() => focusTypingInput(retries - 1, delayMs), delayMs);
}

function getActiveAsciiFrames() {
    return (asciiRunnerFramesOverride && asciiRunnerFramesOverride.length > 0)
        ? asciiRunnerFramesOverride
        : asciiRunnerFrames;
}

function chooseAnimalForSentence(level, sentenceIndex) {
    if (level === 1) return 'rabbit';
    const cycle = ['horse', 'dog', 'cheetah', 'rabbit'];
    return cycle[sentenceIndex % cycle.length];
}

function applyAsciiAnimalForCurrent() {
    if (!asciiRunnerEl || !currentCategory) return;
    const cat = sentenceCategories[currentCategory];
    const level = typeof cat?.level === 'number' ? cat.level : 0;
    const nextAnimal = chooseAnimalForSentence(level, currentSentenceIndex);
    asciiCurrentAnimal = nextAnimal;
    const frames = asciiFramesLibrary[nextAnimal] || [];
    asciiRunnerFramesOverride = frames;
    asciiRunnerIndex = 0;
    asciiKeyCounter = 0;
    asciiLastCorrectCharCount = 0;
    asciiRunnerEl.textContent = frames && frames.length > 0 ? frames[0] : '';
}

function updateAsciiRunner(progressByCorrect = false) {
    if (!asciiRunnerEl) return;
    if (asciiAdvanceOnlyOnCorrect && !progressByCorrect) {
        return;
    }
    const frames = getActiveAsciiFrames();
    if (!frames || frames.length === 0) return;
    asciiKeyCounter++;
    if (asciiKeyCounter % asciiAdvanceEveryN !== 0) return;
    asciiRunnerEl.textContent = frames[asciiRunnerIndex % frames.length];
    asciiRunnerIndex++;
}

function shakeAsciiRunner() {
    if (!asciiRunnerEl) return;
    asciiRunnerEl.classList.remove('shake');
    void asciiRunnerEl.offsetWidth;
    asciiRunnerEl.classList.add('shake');
}

const encourageEl = document.getElementById('encourageMessage');
const encourageMessages = [
    'ì§€ê¸ˆì²˜ëŸ¼ë§Œ! ëê¹Œì§€ ê°€ë³´ì!',
    'ì¢‹ì•„! ë¦¬ë“¬ íƒ”ë‹¤!',
    'ì§‘ì¤‘! ë„ˆë¼ë©´ í•  ìˆ˜ ìˆì–´!',
    'ì†ê°€ë½ì´ ì¶¤ì¶˜ë‹¤! ê³„ì† ê³ !',
    'ì˜¤íƒ€ëŠ” ì ê¹, ì‹¤ë ¥ì€ ì˜ì›!',
    'í•œ ê¸€ìì”©, í™•ì‹¤í•˜ê²Œ!',
    'ì†ë„ë³´ë‹¤ ì¤‘ìš”í•œ ê±´ ì •í™•ë„!',
    'ì¢‹ì€ íë¦„ì´ì•¼! ìœ ì§€í•˜ì!',
    'ì•„ì£¼ ì¢‹ì•„! ë°”ë¡œ ê·¸ê±°ì•¼!',
    'ë”± í•œ ë¬¸ì¥ ë”!',
    'í˜ì´ìŠ¤ ì¢‹ì•„! ê·¸ëŒ€ë¡œ!',
    'ì •í™•! ë©‹ì ¸!',
    'ê¾¸ì¤€í•¨ì´ ì‹¤ë ¥ì„ ë§Œë“ ë‹¤!',
    'ì§‘ì¤‘ ìœ ì§€! ì¶©ë¶„íˆ ê°€ëŠ¥í•´!',
    'í‚¤ë³´ë“œê°€ ìµìˆ™í•´ì§€ëŠ” ì¤‘!',
    'í˜¸í¡ ì¢‹ì•„! ë§¤ë„ëŸ½ë‹¤!',
    'í•œ ê¸€ì í•œ ê¸€ì í™•ì‹¤í•˜ê²Œ!',
    'ì˜¤íƒ€? ê´œì°®ì•„, ë°”ë¡œ íšŒë³µ!',
    'ë‚˜ì´ìŠ¤! ì†ë„ ì˜¬ë¼ê°„ë‹¤!',
    'ì¢‹ì•„! ê²¬ê³ í•´ì§€ê³  ìˆì–´!'
];
const encourageByLevel = {
    1: [ 'ê¸°ë³¸ê¸° íƒ„íƒ„! ì•„ì£¼ ì¢‹ì•„!', 'ì •í™•ë„ê°€ ê³§ ì†ë„ë‹¤!', 'ì¤‘ìš”í•œ ê±´ ì†ê°€ë½ ê¸°ì–µ!' ],
    2: [ 'í™ˆí¬ì§€ì…˜ ìœ ì§€!', 'ë¦¬ë“¬ì„ ê°€ì ¸ê°€ì!', 'ì†ê°€ë½ì´ ë”°ëœ»í•´ì¡Œì–´!' ],
    3: [ 'ìƒë‹¨ í–‰ ì •ë³µ ì¤‘!', 'ì‹œì„ ì€ í™”ë©´, ì†ì€ ìì—°ìŠ¤ëŸ½ê²Œ!', 'í‚¤ ê°„ê²©ì— ìµìˆ™í•´ì§€ê³  ìˆì–´!' ],
    4: [ 'í•˜ë‹¨ í–‰ í”ë“¤ë¦¼ ì—†ë‹¤!', 'ë¶€ë“œëŸ½ê²Œ, ì²œì²œíˆ, ì •í™•íˆ!', 'ê¾¸ì¤€í•¨ì´ ì´ê¸´ë‹¤!' ],
    5: [ 'ì‹¤ì „ ê°ê° ì˜¬ë¼ì˜¨ë‹¤!', 'ë¬¸ì¥ í˜¸í¡ ì¡í˜”ë‹¤!', 'ë©‹ì§„ í˜ì´ìŠ¤ì•¼!' ]
};

function pickFrom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function pickEncourage(kind = 'general') {
    const cat = currentCategory ? sentenceCategories[currentCategory] : null;
    const level = typeof cat?.level === 'number' ? cat.level : 0;
    const levelArr = encourageByLevel[level] || [];
    if (kind === 'error') {
        return pickFrom([ 'ê´œì°®ì•„! ë‹¤ì‹œ í•œ ë²ˆ!', 'ì²œì²œíˆ, ì •í™•íˆ!', 'ì˜¤íƒ€ëŠ” ì ê¹, ë‹¤ì‹œ ê³ !' ]);
    }
    if (kind === 'partial') {
        return pickFrom([ 'ì¢‹ì•„! í•œ ê¸€ì ë”!', 'ë¦¬ë“¬ ì¢‹ë‹¤! ê³„ì†!', 'ì•„ì£¼ ì¢‹ì•„, ìœ ì§€!' ]);
    }
    if (kind === 'success') {
        return pickFrom([ 'ì™„ë²½! ë©‹ì§€ë‹¤!', 'ê¹”ë”í–ˆë‹¤!', 'ì¢‹ì•˜ì–´! ë‹¤ìŒìœ¼ë¡œ!' ]);
    }
    // general
    if (levelArr.length && Math.random() < 0.6) return pickFrom(levelArr);
    return pickFrom(encourageMessages);
}
function showEncourage(kind = 'general') {
    if (!encourageEl) return;
    encourageEl.classList.remove('fade-in');
    encourageEl.textContent = pickEncourage(kind);
    // reflow to restart animation
    void encourageEl.offsetWidth;
    encourageEl.classList.add('fade-in');
}

function renderSentenceHighlight(target, input) {
    if (!sentenceDisplay) return;
    const escape = (s) => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const max = Math.min(target.length, input.length);
    let idx = 0;
    while (idx < max && target[idx] === input[idx]) idx++;
    let correct = escape(target.slice(0, idx));
    let rest = escape(target.slice(idx));
    // ê³µë°± ë³´ì¡´: ì¼ë°˜ ê³µë°±ì„ &nbsp;ë¡œ ì¹˜í™˜í•´ ê²½ê³„ ê³µë°± ì†Œì‹¤ ë°©ì§€
    correct = correct.replace(/ /g, '&nbsp;');
    rest = rest.replace(/ /g, '&nbsp;');
    sentenceDisplay.innerHTML = `<span class="typed-correct">${correct}</span>${rest}`;
}

function clearMovieTitleReveal() {
    const existing = document.getElementById('movieTitleReveal');
    if (existing) existing.remove();
}
function revealMovieTitleAtIndex(index) {
    if (currentCategory !== 'movieQuiz') return;
    const cat = sentenceCategories[currentCategory];
    const titles = cat && cat.titles;
    if (!Array.isArray(titles) || !titles[index]) return;
    const title = titles[index];
    // íƒ€ì´í‹€ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± ë° ì‚½ì…
    clearMovieTitleReveal();
    const el = document.createElement('div');
    el.id = 'movieTitleReveal';
    el.textContent = `ì •ë‹µ: "${title}"`;
    el.style.marginTop = '8px';
    el.style.fontWeight = '700';
    el.style.color = '#2b6cb0';
    el.style.fontSize = '0.95rem';
    el.style.opacity = '0';
    el.style.transition = 'opacity 200ms ease';
    sentenceDisplay.appendChild(el);
    requestAnimationFrame(() => { el.style.opacity = '1'; });
}

function updateDisplay() {
    if (!currentCategory) return;
    const currentSentences = sentenceCategories[currentCategory].sentences;
    const targetText = currentSentences[currentSentenceIndex];
    renderSentenceHighlight(targetText, typingInput ? typingInput.value : '');
    // ë¬¸ì¥ ê¸¸ì´ì— ë”°ë¥¸ ì»¨í…Œì´ë„ˆ í­ ì¡°ì •
    setContainerWidthForSentence(targetText);
    // ì˜í™” ì œëª© ë…¸ì¶œ ì´ˆê¸°í™”
    clearMovieTitleReveal();
    progressBar.style.width = `${((currentSentenceIndex + 1) / currentSentences.length) * 100}%`;

    // ë‚¨ì€ ë¬¸ì¥ ìˆ˜ í‘œì‹œ (í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ì„ê³„ì¹˜ê¹Œì§€ ë‚¨ì€ ê°œìˆ˜)
    if (remainingInfo) {
        let remaining;
        if (isTestMode) {
            const threshold = Math.max(1, Math.ceil(currentSentences.length * TEST_MODE_THRESHOLD_RATIO));
            const done = Math.min(currentSentenceIndex + 1, threshold);
            remaining = Math.max(0, threshold - done);
            remainingInfo.textContent = `ë‹¤ìŒ ë‹¨ê³„ê¹Œì§€ ë‚¨ì€ ë¬¸ì¥: ${remaining} (í…ŒìŠ¤íŠ¸)`;
        } else {
            remaining = currentSentences.length - (currentSentenceIndex + 1);
            remainingInfo.textContent = `ë‹¤ìŒ ë‹¨ê³„ê¹Œì§€ ë‚¨ì€ ë¬¸ì¥: ${remaining}`;
        }
    }

    // ì¹´í…Œê³ ë¦¬/ë¬¸ì¥ ë³€ê²½ë§ˆë‹¤ í˜„ì¬ ë ˆë²¨ ê·œì¹™ì— ë§ëŠ” ë™ë¬¼ ì ìš© ë° ì‘ì› ë¬¸êµ¬ í‘œì‹œ
    applyAsciiAnimalForCurrent();
    setAsciiScale();
    showEncourage('general');
}

function shouldAutoAdvanceInTestMode() {
    if (!isTestMode) return false;
    const totalSentences = sentenceCategories[currentCategory].sentences.length;
    const threshold = Math.max(1, Math.ceil(totalSentences * TEST_MODE_THRESHOLD_RATIO));
    return currentSentenceIndex + 1 >= threshold; // +1ì€ í˜„ì¬ ì¸ë±ìŠ¤ê°€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ ì§„í–‰ ê°œìˆ˜ ë³´ì •
}

function startTimer() {
    startTime = Date.now();
    timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        totalTime = elapsed;
    }, 1000);
}

function stopTimer() {
    if (timer) {
        clearInterval(timer);
        timer = null;
    }
}

function calculateWPM() {
    if (totalTime === 0) return 0;
    const minutes = totalTime / 60;
    return Math.round(totalWords / minutes);
}

function calculateAccuracy() {
    if (totalWords === 0) return 100;
    return Math.round((correctWords / totalWords) * 100);
}

function updateStats() {
    wpmDisplay.textContent = calculateWPM();
    accuracyDisplay.textContent = `${calculateAccuracy()}%`;
}

function checkAccuracy(input, target) {
    const inputWords = input.trim().split(/\s+/);
    const targetWords = target.trim().split(/\s+/);

    let correct = 0;
    for (let i = 0; i < Math.min(inputWords.length, targetWords.length); i++) {
        if (inputWords[i] === targetWords[i]) {
            correct++;
        }
    }

    return {
        correct,
        total: targetWords.length,
        percentage: Math.round((correct / targetWords.length) * 100)
    };
}

function startTyping() {
    isTyping = true;
    startTimer();
    if (typingInput) typingInput.focus();
    startBtn.textContent = 'ì¼ì‹œì •ì§€';
    startBtn.classList.remove('btn-primary');
    startBtn.classList.add('btn-secondary');
}

function pauseTyping() {
    isTyping = false;
    stopTimer();
    startBtn.textContent = 'ê³„ì†';
    startBtn.classList.remove('btn-secondary');
    startBtn.classList.add('btn-primary');
}

function resetTyping() {
    currentSentenceIndex = 0;
    totalWords = 0;
    totalTime = 0;
    correctWords = 0;
    errorWords = [];
    sessionErrors = [];
    isTyping = false;
    stopTimer();
    typingInput.value = '';
    typingInput.className = 'typing-input';
    accuracyIndicator.textContent = '';
    timerDisplay.textContent = '00:00';
    wpmDisplay.textContent = '0';
    accuracyDisplay.textContent = '100%';
    startBtn.textContent = 'ì‹œì‘';
    startBtn.classList.remove('btn-secondary');
    startBtn.classList.add('btn-primary');
    updateDisplay();
}

function nextSentence() {
    if (!currentCategory) return;
    const isLastSentence = currentSentenceIndex >= sentenceCategories[currentCategory].sentences.length - 1;

    if (!isLastSentence) {
        currentSentenceIndex++;
        typingInput.value = '';
        typingInput.className = 'typing-input';
        accuracyIndicator.textContent = '';
        updateDisplay();
    }

    if (isLastSentence || shouldAutoAdvanceInTestMode()) {
        const nextKey = getNextCategoryKey(currentCategory);
        if (nextKey) {
            // í˜„ì¬ ë‹¨ê³„ í†µê³„ ì €ì¥ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
            saveSessionStats();
            goToCategory(nextKey, true);
            if (!isTyping) {
                // ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì§€ ì•Šì•˜ì–´ë„ ë‹¤ìŒ ë ˆë²¨ ìë™ ì‹œì‘
                startTyping();
            }
            showToast(`${sentenceCategories[nextKey].name} ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.`)
        } else {
            saveSessionStats();
            pauseTyping();
        }
    }
}

// ì„¸ì…˜ í†µê³„ ì €ì¥
function saveSessionStats() {
    const sessionData = {
        date: new Date().toISOString(),
        category: currentCategory,
        wpm: calculateWPM(),
        accuracy: calculateAccuracy(),
        totalWords: totalWords,
        totalErrors: sessionErrors.length,
        errorWords: sessionErrors,
        duration: totalTime
    };

    const existingStats = localStorage.getItem('typingStats');
    const stats = existingStats ? JSON.parse(existingStats) : [];
    stats.push(sessionData);
    localStorage.setItem('typingStats', JSON.stringify(stats));
}

let audioContext = null;
let lastBeepAt = 0;
function playErrorBeep() {
    try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        if (!audioContext) audioContext = new AudioCtx();
        // ê°„ë‹¨í•œ ìŠ¤ë¡œí‹€: 50ms ì´ë‚´ ì¤‘ë³µ ë°©ì§€
        const nowMs = Date.now();
        if (nowMs - lastBeepAt < 50) return;
        lastBeepAt = nowMs;

        const duration = 0.08; // 80ms
        const now = audioContext.currentTime;
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(700, now);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.22, now + 0.005);
        gain.gain.linearRampToValueAtTime(0.0, now + duration);
        osc.connect(gain).connect(audioContext.destination);
        osc.start(now);
        osc.stop(now + duration + 0.02);
    } catch (e) {
        // ignore audio errors
    }
}

let lastSuccessAt = 0;
function playSuccessTone() {
    try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        if (!audioContext) audioContext = new AudioCtx();
        // ìŠ¤ë¡œí‹€: 30ms
        const nowMs = Date.now();
        if (nowMs - lastSuccessAt < 30) return;
        lastSuccessAt = nowMs;

        const duration = 0.09; // 90ms
        const now = audioContext.currentTime;
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(220, now); // ì €ìŒ A3 ê·¼ì²˜
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.15, now + 0.005);
        gain.gain.linearRampToValueAtTime(0.0, now + duration);
        osc.connect(gain).connect(audioContext.destination);
        osc.start(now);
        osc.stop(now + duration + 0.02);
    } catch (_) {
        // ignore
    }
}

let movieChoicesActive = false;
let movieShuffledCorrectIndex = {};
function clearMovieChoices() {
    const el = document.getElementById('movieChoices');
    if (el) el.remove();
    movieChoicesActive = false;
}
function showMovieChoicesAtIndex(index) {
    if (currentCategory !== 'movieQuiz') return;
    const cat = sentenceCategories[currentCategory];
    const originalChoices = Array.isArray(cat.choices) ? cat.choices[index] : null;
    if (!originalChoices || originalChoices.length === 0) return;

    // ì •ë‹µ ì¸ë±ìŠ¤(ì›ë³¸ì—ì„œì˜ ìœ„ì¹˜). ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ê°€ì •
    const originalCorrect = Array.isArray(cat.answers) ? cat.answers[index] : 0;

    // ì„ê¸°: [í…ìŠ¤íŠ¸, ì›ë˜ ì¸ë±ìŠ¤] ìŒìœ¼ë¡œ ì…”í”Œ
    const entries = originalChoices.map((text, i) => ({ text, originalIndex: i }));
    for (let i = entries.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const tmp = entries[i];
        entries[i] = entries[j];
        entries[j] = tmp;
    }

    // ì„ì¸ ë°°ì—´ì—ì„œ ì •ë‹µì˜ ìƒˆ ìœ„ì¹˜ë¥¼ ê¸°ë¡
    const shuffledCorrectIdx = entries.findIndex(e => e.originalIndex === originalCorrect);
    movieShuffledCorrectIndex[index] = shuffledCorrectIdx;

    clearMovieChoices();
    const wrap = document.createElement('div');
    wrap.id = 'movieChoices';
    wrap.dataset.questionIndex = String(index);
    wrap.dataset.correctIndex = String(shuffledCorrectIdx);
    wrap.style.marginTop = '6px';
    wrap.style.display = 'grid';
    wrap.style.gridTemplateColumns = '1fr 1fr';
    wrap.style.gap = '6px';

    entries.forEach((entry, i) => {
        const btn = document.createElement('button');
        btn.textContent = `${i + 1}. ${entry.text}`;
        btn.style.padding = '6px 8px';
        btn.style.border = '1px solid #cbd5e1';
        btn.style.borderRadius = '8px';
        btn.style.background = '#fff';
        btn.style.cursor = 'pointer';
        btn.addEventListener('click', () => verifyMovieAnswer(index, i));
        wrap.appendChild(btn);
    });

    sentenceDisplay.appendChild(wrap);
    movieChoicesActive = true;
    focusTypingInput();
}
function verifyMovieAnswer(index, selectedIdx) {
    const cat = sentenceCategories[currentCategory];
    const wrap = document.getElementById('movieChoices');
    // ë°ì´í„°ì…‹ ìš°ì„  (ì…”í”Œ ì´í›„ ì •í™•)
    let correctIdx = -1;
    if (wrap && typeof wrap.dataset.correctIndex === 'string') {
        correctIdx = parseInt(wrap.dataset.correctIndex, 10);
    } else {
        const correctIdxOriginal = Array.isArray(cat.answers) ? cat.answers[index] : -1;
        correctIdx = (typeof movieShuffledCorrectIndex[index] === 'number') ? movieShuffledCorrectIndex[index] : correctIdxOriginal;
    }
    const isCorrect = selectedIdx === correctIdx;

    if (wrap) {
        const btns = wrap.querySelectorAll('button');
        btns.forEach((b, i) => {
            b.disabled = true;
            b.style.cursor = 'default';
            if (i === correctIdx) {
                b.style.background = '#e6ffed';
                b.style.borderColor = '#34d399';
            }
            if (i === selectedIdx && !isCorrect) {
                b.style.background = '#ffe6e6';
                b.style.borderColor = '#f87171';
            }
        });
    }

    // ì •ë‹µ/ì˜¤ë‹µ í…ìŠ¤íŠ¸ í‘œì‹œ
    clearMovieTitleReveal();
    const feed = document.createElement('div');
    feed.id = 'movieTitleReveal';
    const correctTitle = (cat.titles && cat.titles[index]) ? cat.titles[index] : '';
    feed.textContent = isCorrect ? `ì •ë‹µì…ë‹ˆë‹¤! â†’ "${correctTitle}"` : `ì˜¤ë‹µì…ë‹ˆë‹¤! ì •ë‹µì€ "${correctTitle}"`;
    feed.style.marginTop = '8px';
    feed.style.fontWeight = '700';
    feed.style.color = isCorrect ? '#065f46' : '#991b1b';
    feed.style.fontSize = '0.95rem';
    feed.style.opacity = '0';
    feed.style.transition = 'opacity 200ms ease';
    const anchor = document.getElementById('encourageMessage');
    if (anchor) {
        anchor.insertAdjacentElement('afterend', feed);
    } else {
        sentenceDisplay.appendChild(feed);
    }
    requestAnimationFrame(() => { feed.style.opacity = '1'; });

    // ë‹¤ìŒ ì§„í–‰ ì•ˆë‚´
    const hint = document.createElement('div');
    hint.style.marginTop = '4px';
    hint.style.fontSize = '0.85rem';
    hint.style.color = '#475569';
    hint.textContent = 'ê³„ì†í• ì§€ ì¢…ë£Œí• ì§€ ì•„ë˜ ë²„íŠ¼ì„ ì„ íƒí•˜ì„¸ìš”.';
    sentenceDisplay.appendChild(hint);

    setTimeout(() => {
        askContinueOrExit();
    }, 400);
}
function onMovieNumberKey(e) {
    if (!movieChoicesActive) return;
    const key = e.key;
    if (!/^[1-9]$/.test(key)) return;
    e.preventDefault();
    e.stopPropagation();
    const wrap = document.getElementById('movieChoices');
    if (!wrap) return;
    const idx = parseInt(key, 10) - 1;
    const btns = wrap.querySelectorAll('button');
    if (idx >= 0 && idx < btns.length) {
        btns[idx].click();
    }
}
function askContinueOrExit() {
    // ê¸°ì¡´ confirm ëŒ€ì‹  ë²„íŠ¼ UI í‘œì‹œ
    // ì´ì „ ì´ì–´ì„œ/ì¢…ë£Œ UI ì œê±°
    const old = document.getElementById('movieContinueExit');
    if (old) old.remove();

    const wrap = document.createElement('div');
    wrap.id = 'movieContinueExit';
    wrap.style.marginTop = '8px';
    wrap.style.display = 'flex';
    wrap.style.gap = '8px';

    const continueBtn = document.createElement('button');
    continueBtn.textContent = 'ê³„ì†í•˜ê¸°';
    continueBtn.style.padding = '6px 10px';
    continueBtn.style.border = '1px solid #cbd5e1';
    continueBtn.style.borderRadius = '8px';
    continueBtn.style.background = '#10b981';
    continueBtn.style.color = '#fff';
    continueBtn.style.cursor = 'pointer';

    const exitBtn = document.createElement('button');
    exitBtn.textContent = 'ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°';
    exitBtn.style.padding = '6px 10px';
    exitBtn.style.border = '1px solid #cbd5e1';
    exitBtn.style.borderRadius = '8px';
    exitBtn.style.background = '#64748b';
    exitBtn.style.color = '#fff';
    exitBtn.style.cursor = 'pointer';

    continueBtn.addEventListener('click', () => {
        clearMovieTitleReveal();
        clearMovieChoices();
        wrap.remove();
        nextSentence();
        focusTypingInput();
    });

    exitBtn.addEventListener('click', () => {
        clearMovieTitleReveal();
        clearMovieChoices();
        wrap.remove();
        backToMenu();
        focusTypingInput();
    });

    wrap.appendChild(continueBtn);
    wrap.appendChild(exitBtn);
    const anchorForBtns = document.getElementById('encourageMessage');
    if (anchorForBtns) {
        anchorForBtns.insertAdjacentElement('afterend', wrap);
    } else {
        sentenceDisplay.appendChild(wrap);
    }
}
// ë²ˆí˜¸í‚¤ë¡œ ë³´ê¸° ì„ íƒ í•¸ë“¤ëŸ¬ ë“±ë¡
window.addEventListener('keydown', onMovieNumberKey);

typingInput.addEventListener('input', (e) => {
    if (!currentCategory) return;

    const input = e.target.value;
    const target = sentenceCategories[currentCategory].sentences[currentSentenceIndex];

    // ë¬¸ì¥ í•˜ì´ë¼ì´íŠ¸ ê°±ì‹ 
    renderSentenceHighlight(target, input);

    // í‚¤ ì…ë ¥ë§ˆë‹¤ í”„ë ˆì„ ì—…ë°ì´íŠ¸ (ìš”ì²­ ì‚¬í•­)
    updateAsciiRunner(false);

    if (input.length > 0) {
        const accuracy = checkAccuracy(input, target);
       // accuracyIndicator.textContent = `ì •í™•ë„: ${accuracy.percentage}%`;

        // ì˜¤íƒ€ ì¶”ì 
        if (input.length > 0 && !target.startsWith(input)) {
            const currentWord = input.split(' ').pop();
            const targetWord = target.split(' ')[input.split(' ').length - 1];
            if (currentWord && targetWord && currentWord !== targetWord) {
                const error = {
                    word: targetWord,
                    typed: currentWord,
                    timestamp: Date.now()
                };
                if (!sessionErrors.find(e => e.word === targetWord && e.typed === currentWord)) {
                    sessionErrors.push(error);
                }
            }
            // ì˜¤íƒ€ ì‹œ í”ë“¤ë¦¼ + ê²½ê³ ìŒ
            shakeAsciiRunner();
            playErrorBeep();
            showEncourage('error');
        }

        if (input === target) {
            e.target.classList.add('correct');
            e.target.classList.remove('incorrect');

            // í†µê³„ëŠ” íƒ€ì´í•‘ ì„¸ì…˜ì´ ì‹œì‘ëœ ìƒíƒœì¼ ë•Œë§Œ ì§‘ê³„
            if (isTyping) {
                correctWords += target.split(/\s+/).length;
                totalWords += target.split(/\s+/).length;
                updateStats();
            }

            // ë¬¸ì¥ ì™„ì„± ì„±ê³µìŒ
            playSuccessTone();
            showEncourage('success');
            // ì˜í™” í€´ì¦ˆì¼ ê²½ìš° ì œëª© ë…¸ì¶œ
            revealMovieTitleAtIndex(currentSentenceIndex);
            // ê·¸ë¦¬ê³  ê°ê´€ì‹ ë³´ê¸° í‘œì‹œ
            showMovieChoicesAtIndex(currentSentenceIndex);

            setTimeout(() => {
                if (currentCategory === 'movieQuiz') {
                    return; // ì˜í™” í€´ì¦ˆëŠ” ë²„íŠ¼ìœ¼ë¡œ ê³„ì†/ì¢…ë£Œë¥¼ ê²°ì •
                }
                nextSentence();
            }, 0);
        } else if (target.startsWith(input)) {
            e.target.classList.remove('incorrect');
            e.target.classList.remove('correct');
            // ë¶€ë¶„ ì •ë‹µ ì§„í–‰ ì¹´ìš´íŠ¸ë§Œ ì—…ë°ì´íŠ¸
            if (input.length > asciiLastCorrectCharCount) {
                asciiLastCorrectCharCount = input.length;
                // ì˜¬ë°”ë¥´ê²Œ í•œ ê¸€ì ì§„í–‰ë  ë•Œ ë¶€ë“œëŸ¬ìš´ ì„±ê³µìŒ
                playSuccessTone();
                showEncourage('partial');
            }
        } else {
            e.target.classList.add('incorrect');
            e.target.classList.remove('correct');
            // ì˜¤ë‹µ ì¶”ê°€ ì…ë ¥ ì‹œë„ì—ë„ í”ë“¤ë¦¼ë§Œ
            shakeAsciiRunner();
            showEncourage('error');
        }
    } else {
        e.target.classList.remove('correct', 'incorrect');
        accuracyIndicator.textContent = '';
    }
});

startBtn.addEventListener('click', () => {
    if (isTyping) {
        pauseTyping();
    } else {
        startTyping();
    }
});

resetBtn.addEventListener('click', resetTyping);
nextBtn.addEventListener('click', nextSentence);

// ë©”ë‰´ì— ëŒì•„ê°€ê¸° ë²„íŠ¼ ì¶”ê°€
const backButton = document.createElement('button');
backButton.className = 'btn btn-secondary';
backButton.textContent = 'ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°';
backButton.style.marginRight = '10px';
backButton.addEventListener('click', backToMenu);

document.querySelector('.controls').insertBefore(backButton, startBtn);

async function loadSentences() {
    try {
        const res = await fetch('sentences.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to load sentences.json');
        const data = await res.json();
        sentenceCategories = data;
    } catch (err) {
        console.error('[loadSentences] ', err);
    }
}

async function bootstrap() {
    await loadSentences();
    await loadAsciiFrames();
    initializeCategoryMenu();
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => { bootstrap().then(() => setTimeout(() => focusTypingInput(), 0)); }); 

function getCategoryIcon(key, level) {
    const map = {
        middleRowLetters: 'âŒ¨ï¸',
        middleRow: 'ğŸŸª',
        topRow: 'ğŸŸ¥',
        bottomRow: 'ğŸŸ©',
        leftHand: 'ğŸ¤š',
        rightHand: 'âœ‹',
        realEnglish: 'ğŸ“–'
    };
    if (map[key]) return map[key];
    // ë ˆë²¨ ìƒ‰ìƒ ëŒ€ì²´ ì•„ì´ì½˜
    const levelIcon = { 1:'1ï¸âƒ£',2:'2ï¸âƒ£',3:'3ï¸âƒ£',4:'4ï¸âƒ£',5:'5ï¸âƒ£',6:'6ï¸âƒ£',7:'7ï¸âƒ£' }[level || 0];
    return levelIcon || 'âŒ¨ï¸';
} 

function getKeyboardSVG(highlight = 'middle') {
    // rows: top, middle, bottom (10 keys each)
    const baseKey = (x, y, w, h, fill) => `<rect x="${x}" y="${y}" rx="3" ry="3" width="${w}" height="${h}" fill="${fill}" stroke="#bbb"/>`;
    const w = 16, h = 12, gap = 4;
    const colNormal = '#eee';
    const colHL = '#cde4ff';

    const renderRow = (rowIndex, y) => {
        const keys = [];
        for (let i = 0; i < 10; i++) {
            const x = 4 + i * (w + gap);
            let fill = colNormal;
            if (highlight === 'top' && rowIndex === 0) fill = colHL;
            if (highlight === 'middle' && rowIndex === 1) fill = colHL;
            if (highlight === 'middleAlt' && rowIndex === 1 && (i % 2 === 0)) fill = colHL; // ë„ì—„ë„ì—„ í•˜ì´ë¼ì´íŠ¸
            if (highlight === 'bottom' && rowIndex === 2) fill = colHL;
            if (highlight === 'left' && i < 5) fill = colHL;
            if (highlight === 'right' && i >= 5) fill = colHL;
            keys.push(baseKey(x, y, w, h, fill));
        }
        return keys.join('');
    };

    return `
<svg viewBox="0 0 190 60" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <rect x="1" y="1" width="188" height="58" rx="6" ry="6" fill="#f7f7f7" stroke="#ddd"/>
  ${renderRow(0, 10)}
  ${renderRow(1, 26)}
  ${renderRow(2, 42)}
</svg>`;
}

function getHighlightForCategory(key) {
    if (key === 'topRow') return 'top';
    if (key === 'middleRow') return 'middle';
    if (key === 'middleRowLetters') return 'middleAlt';
    if (key === 'bottomRow') return 'bottom';
    if (key === 'leftHand') return 'left';
    if (key === 'rightHand') return 'right';
    // ì‹¤ì „ì€ í•˜ì´ë¼ì´íŠ¸ ì—†ìŒ
    return 'none';
} 

function setContainerWidthForSentence(text) {
    const container = document.querySelector('.container');
    if (!container) return;
    const viewport = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    // ì‘ì€ í™”ë©´ì—ì„œëŠ” í™•ì¥í•˜ì§€ ì•ŠìŒ
    if (viewport < 900) {
        container.style.maxWidth = '';
        return;
    }
    // ì‹¤ì œ í”½ì…€ í­ ì¸¡ì •
    const measure = document.createElement('span');
    // sentenceDisplayê°€ ì¡´ì¬í•œë‹¤ë©´ í•´ë‹¹ ìŠ¤íƒ€ì¼ì„ ì°¸ì¡°
    if (sentenceDisplay) {
        const cs = window.getComputedStyle(sentenceDisplay);
        measure.style.fontFamily = cs.fontFamily;
        measure.style.fontSize = cs.fontSize;
        measure.style.fontWeight = cs.fontWeight;
        measure.style.letterSpacing = cs.letterSpacing;
    }
    measure.style.whiteSpace = 'pre';
    measure.style.visibility = 'hidden';
    measure.style.position = 'absolute';
    measure.style.left = '-9999px';
    measure.style.top = '-9999px';
    measure.textContent = text || '';
    document.body.appendChild(measure);
    const textWidth = measure.offsetWidth;
    document.body.removeChild(measure);

    // ì»¨í…Œì´ë„ˆ/ë¬¸ì¥ íŒ¨ë”© ë“±ì„ ê³ ë ¤í•œ ì—¬ìœ  í­(ì•½ 200px)
    let desired = textWidth + 200;
    // ìµœì†Œ/ìµœëŒ€ í•œê³„
    if (desired < 800) desired = 800;
    if (desired > 1600) desired = 1600;
    container.style.maxWidth = `${Math.round(desired)}px`;
} 

// í˜„ì¬ íƒ€ê¹ƒ ë¬¸ì¥ ë°˜í™˜ í—¬í¼
function getCurrentTargetText() {
    if (!currentCategory) return '';
    const sentences = sentenceCategories[currentCategory]?.sentences;
    if (!Array.isArray(sentences)) return '';
    return sentences[currentSentenceIndex] || '';
}

// ë¦¬ì‚¬ì´ì¦ˆ ì‹œ í­ ì¬ê³„ì‚°
window.addEventListener('resize', () => {
    const t = getCurrentTargetText();
    if (t) setContainerWidthForSentence(t);
}); 